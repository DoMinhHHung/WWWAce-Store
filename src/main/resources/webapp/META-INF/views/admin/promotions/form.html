<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout (~{::body})}">
<head>
    <title>Admin - Promotion Form</title>
</head>
<body>
<section>
    <h1 id="mode-title">Create Promotion</h1>
    <form id="promo-form">
        <input type="hidden" id="promo-id" />
        <div><label>Name: <input id="name" name="name" /></label></div>
        <div><label>Description: <textarea id="description" name="description"></textarea></label></div>
        <div><label>Discount Percent: <input id="discountPercent" name="discountPercent" type="number" step="0.01" /></label></div>
        <div><label>Start Date: <input id="startDate" name="startDate" type="date" /></label></div>
        <div><label>End Date: <input id="endDate" name="endDate" type="date" /></label></div>
        <div><label>Active: <input id="active" name="active" type="checkbox" /></label></div>
        <button type="submit">Save</button>
        <a href="/admin/promotions">Back</a>
    </form>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const match = location.pathname.match(/\/admin\/promotions\/(\d+)\/edit/);
        const form = document.getElementById('promo-form');

        if (match) {
            const id = match[1];
            document.getElementById('promo-id').value = id;
            document.getElementById('mode-title').innerText = 'Edit Promotion ' + id;
            fetch('/api/promotions/' + id).then(r=>r.json()).then(res=>{
                if (!res.success) { alert('Error: ' + res.message); return; }
                const p = res.data;
                document.getElementById('name').value = p.name || '';
                document.getElementById('description').value = p.description || '';
                document.getElementById('discountPercent').value = p.discountPercent || '';
                document.getElementById('startDate').value = p.startDate || '';
                document.getElementById('endDate').value = p.endDate || '';
                document.getElementById('active').checked = !!p.active;
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('promo-id').value;
            const body = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
                startDate: document.getElementById('startDate').value || null,
                endDate: document.getElementById('endDate').value || null,
                active: document.getElementById('active').checked
            };
            const url = id ? '/api/promotions/' + id : '/api/promotions';
            const method = id ? 'PUT' : 'POST';
            try {
                const r = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const rr = await r.json();
                if (rr.success) {
                    alert('Saved');
                    window.location.href = '/admin/promotions';
                } else alert('Error: ' + rr.message);
            } catch (err) { alert('Submit error: ' + err); }
        });
    });
</script>
</body>
</html>